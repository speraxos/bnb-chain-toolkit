/**
 * ‚ú® built by nich
 * üåê GitHub: github.com/nirholas
 * üí´ Keep pushing boundaries üöß
 */

import { useState } from 'react';
import {
  Shield,
  Bug,
  Target,
  Siren,
  CheckCircle,
  XCircle,
  Zap,
  Brain,
  Sword,
  Heart,
  Skull,
  Award,
  TrendingUp
} from 'lucide-react';

interface Attack {
  id: string;
  name: string;
  type: 'reentrancy' | 'overflow' | 'frontrunning' | 'flashloan' | 'delegation' | 'oracle';
  severity: 'critical' | 'high' | 'medium';
  description: string;
  attackVector: string;
  successRate: number;
  potentialDamage: number;
  defense: string;
}

interface DefenseStrategy {
  name: string;
  effectiveness: number;
  cost: number;
  description: string;
}

export default function ExploitLab({
  code,
  onLog
}: {
  code: string;
  onLog: (type: 'info' | 'success' | 'error' | 'warning', message: string) => void;
}) {
  const [detectedVulnerabilities, setDetectedVulnerabilities] = useState<Attack[]>([]);
  const [isScanning, setIsScanning] = useState(false);
  const [selectedAttack, setSelectedAttack] = useState<Attack | null>(null);
  const [attackInProgress, setAttackInProgress] = useState(false);
  const [attackResult, setAttackResult] = useState<{
    success: boolean;
    damage: number;
    trace: string[];
  } | null>(null);
  const [ethicalMode, setEthicalMode] = useState(true);
  const [exploitsFound, setExploitsFound] = useState(0);
  const [exploitsFixed, setExploitsFixed] = useState(0);

  const availableAttacks: Attack[] = [
    {
      id: 'reentrancy',
      name: 'üîÑ Reentrancy Attack',
      type: 'reentrancy',
      severity: 'critical',
      description: 'Exploit recursive calls before state updates',
      attackVector: 'External call before balance update',
      successRate: 0.85,
      potentialDamage: 1000000,
      defense: 'Use ReentrancyGuard or Checks-Effects-Interactions pattern'
    },
    {
      id: 'overflow',
      name: 'üí• Integer Overflow',
      type: 'overflow',
      severity: 'critical',
      description: 'Manipulate arithmetic to wrap around limits',
      attackVector: 'Unchecked arithmetic operations',
      successRate: 0.75,
      potentialDamage: 500000,
      defense: 'Use Solidity ^0.8.0 or SafeMath'
    },
    {
      id: 'frontrun',
      name: 'üèÉ Front-Running Attack',
      type: 'frontrunning',
      severity: 'high',
      description: 'Monitor mempool and execute transactions first',
      attackVector: 'Transaction ordering manipulation',
      successRate: 0.65,
      potentialDamage: 250000,
      defense: 'Use commit-reveal scheme or private transactions'
    },
    {
      id: 'flashloan',
      name: '‚ö° Flash Loan Attack',
      type: 'flashloan',
      severity: 'critical',
      description: 'Borrow massive amounts to manipulate prices',
      attackVector: 'Price oracle manipulation',
      successRate: 0.70,
      potentialDamage: 5000000,
      defense: 'Use TWAP oracles and circuit breakers'
    },
    {
      id: 'delegation',
      name: 'üé≠ Delegatecall Attack',
      type: 'delegation',
      severity: 'critical',
      description: 'Execute malicious code in contract context',
      attackVector: 'Unprotected delegatecall',
      successRate: 0.80,
      potentialDamage: 2000000,
      defense: 'Whitelist delegatecall targets and use proper access control'
    },
    {
      id: 'oracle',
      name: 'üîÆ Oracle Manipulation',
      type: 'oracle',
      severity: 'high',
      description: 'Manipulate external data feeds',
      attackVector: 'Single point of truth',
      successRate: 0.60,
      potentialDamage: 1500000,
      defense: 'Use decentralized oracles with multiple sources'
    }
  ];

  const scanForVulnerabilities = async () => {
    setIsScanning(true);
    onLog('info', 'üîç Scanning contract for vulnerabilities...');

    await new Promise(resolve => setTimeout(resolve, 1500));

    const vulnerabilities: Attack[] = [];

    // Reentrancy detection
    if ((code.includes('.call{value:') || code.includes('.transfer(')) && 
        !code.includes('ReentrancyGuard') &&
        !code.includes('nonReentrant')) {
      vulnerabilities.push(availableAttacks[0]);
    }

    // Overflow detection
    if (!code.includes('pragma solidity ^0.8') && 
        !code.includes('SafeMath') &&
        (code.includes('uint') && (code.includes('+') || code.includes('-') || code.includes('*')))) {
      vulnerabilities.push(availableAttacks[1]);
    }

    // Front-running detection
    if (code.includes('function') && code.includes('public') && 
        (code.includes('price') || code.includes('rate') || code.includes('swap'))) {
      vulnerabilities.push(availableAttacks[2]);
    }

    // Flash loan vulnerability
    if (code.includes('price') && code.includes('balance') && 
        !code.includes('oracle') && !code.includes('TWAP')) {
      vulnerabilities.push(availableAttacks[3]);
    }

    // Delegatecall detection
    if (code.includes('delegatecall') && !code.includes('onlyOwner') && 
        !code.includes('require(msg.sender')) {
      vulnerabilities.push(availableAttacks[4]);
    }

    // Oracle issues
    if (code.includes('oracle') && code.includes('price') && 
        !code.includes('multiple') && !code.includes('average')) {
      vulnerabilities.push(availableAttacks[5]);
    }

    setDetectedVulnerabilities(vulnerabilities);
    setExploitsFound(vulnerabilities.length);
    setIsScanning(false);

    if (vulnerabilities.length > 0) {
      onLog('error', `üö® Found ${vulnerabilities.length} critical vulnerabilities!`);
    } else {
      onLog('success', '‚úÖ No critical vulnerabilities detected!');
    }
  };

  const launchAttack = async (attack: Attack) => {
    if (!ethicalMode) {
      onLog('error', '‚ö†Ô∏è Ethical mode required for attack simulation');
      return;
    }

    setAttackInProgress(true);
    setSelectedAttack(attack);
    onLog('warning', `‚öîÔ∏è Simulating ${attack.name}...`);

    const trace: string[] = [];
    
    // Simulate attack steps
    trace.push('üéØ Identifying vulnerable function...');
    await new Promise(resolve => setTimeout(resolve, 500));
    
    trace.push('üîß Preparing exploit payload...');
    await new Promise(resolve => setTimeout(resolve, 500));
    
    trace.push('üì° Deploying attacker contract...');
    await new Promise(resolve => setTimeout(resolve, 500));
    
    trace.push('üí£ Executing attack transaction...');
    await new Promise(resolve => setTimeout(resolve, 700));

    // Calculate success
    const success = Math.random() < attack.successRate;
    const actualDamage = success 
      ? Math.floor(attack.potentialDamage * (Math.random() * 0.5 + 0.5))
      : 0;

    if (success) {
      trace.push(`üí∞ Attack succeeded! Drained ${actualDamage.toLocaleString()} wei`);
      trace.push(`üîì Vulnerability confirmed: ${attack.attackVector}`);
    } else {
      trace.push('‚ùå Attack failed! Contract defenses held');
      trace.push('‚úÖ Good security practices detected');
    }

    setAttackResult({ success, damage: actualDamage, trace });
    setAttackInProgress(false);

    if (success) {
      onLog('error', `üí• Attack succeeded! Potential loss: $${(actualDamage / 1e18 * 2000).toFixed(2)}`);
    } else {
      onLog('success', 'üõ°Ô∏è Attack defended successfully!');
      setExploitsFixed(prev => prev + 1);
    }
  };

  const getDefenseStrategies = (attack: Attack): DefenseStrategy[] => {
    const strategies: Record<Attack['type'], DefenseStrategy[]> = {
      reentrancy: [
        { name: 'ReentrancyGuard', effectiveness: 95, cost: 2000, description: 'OpenZeppelin modifier' },
        { name: 'Checks-Effects-Interactions', effectiveness: 90, cost: 0, description: 'Design pattern' },
        { name: 'Mutex Lock', effectiveness: 85, cost: 5000, description: 'Manual lock mechanism' }
      ],
      overflow: [
        { name: 'Solidity ^0.8.0', effectiveness: 100, cost: 0, description: 'Built-in overflow protection' },
        { name: 'SafeMath Library', effectiveness: 95, cost: 1000, description: 'OpenZeppelin library' }
      ],
      frontrunning: [
        { name: 'Commit-Reveal', effectiveness: 85, cost: 3000, description: 'Two-phase transactions' },
        { name: 'Flashbots', effectiveness: 90, cost: 1000, description: 'Private transaction pool' },
        { name: 'Minimum Time Locks', effectiveness: 70, cost: 2000, description: 'Delay execution' }
      ],
      flashloan: [
        { name: 'TWAP Oracle', effectiveness: 90, cost: 5000, description: 'Time-weighted average price' },
        { name: 'Circuit Breakers', effectiveness: 85, cost: 3000, description: 'Emergency pause' },
        { name: 'Multiple Oracles', effectiveness: 80, cost: 4000, description: 'Decentralized price feeds' }
      ],
      delegation: [
        { name: 'Whitelist Targets', effectiveness: 95, cost: 2000, description: 'Approved contracts only' },
        { name: 'Access Control', effectiveness: 90, cost: 1500, description: 'Role-based permissions' }
      ],
      oracle: [
        { name: 'Chainlink VRF', effectiveness: 95, cost: 3000, description: 'Verifiable randomness' },
        { name: 'Multiple Sources', effectiveness: 85, cost: 4000, description: 'Aggregate data feeds' }
      ]
    };

    return strategies[attack.type] || [];
  };

  return (
    <div className="h-full flex flex-col bg-gradient-to-br from-red-50 to-orange-50 dark:from-gray-900 dark:to-red-900/20">
      {/* Header */}
      <div className="p-4 bg-gradient-to-r from-red-600 to-orange-600 text-white">
        <div className="flex items-center justify-between mb-3">
          <div className="flex items-center space-x-2">
            <Shield className="w-6 h-6" />
            <h3 className="font-bold text-lg">Ethical Exploit Laboratory</h3>
            <span className="px-2 py-0.5 text-xs bg-purple-400/20 text-purple-200 rounded border border-purple-400/30">
              Experimental
            </span>
          </div>
          <div className="flex items-center space-x-2">
            <button
              onClick={scanForVulnerabilities}
              disabled={isScanning}
              className="px-3 py-2 bg-white/20 hover:bg-white/30 rounded-lg text-sm font-medium transition-all disabled:opacity-50"
            >
              {isScanning ? 'üîç Scanning...' : 'üîé Scan Contract'}
            </button>
          </div>
        </div>

        {/* Ethical Mode Toggle */}
        <div className="flex items-center justify-between text-sm">
          <label className="flex items-center space-x-2 cursor-pointer">
            <input
              type="checkbox"
              checked={ethicalMode}
              onChange={(e) => setEthicalMode(e.target.checked)}
              className="rounded"
            />
            <span>üõ°Ô∏è Ethical Mode (Education Only)</span>
          </label>
          <div className="flex items-center space-x-4 text-xs">
            <span>‚ö†Ô∏è {exploitsFound} found</span>
            <span>‚úÖ {exploitsFixed} fixed</span>
          </div>
        </div>
      </div>

      {/* Warning Banner */}
      <div className="p-3 bg-yellow-100 dark:bg-yellow-900/20 border-b border-yellow-300 dark:border-yellow-800">
        <div className="flex items-center space-x-2 text-sm text-yellow-800 dark:text-yellow-200">
          <Siren className="w-4 h-4" />
          <span>
            üéì Educational Tool - Learn to defend against common attacks. Never exploit real contracts!
          </span>
        </div>
      </div>

      {/* Vulnerabilities Grid */}
      <div className="flex-1 overflow-y-auto p-4">
        {detectedVulnerabilities.length > 0 && (
          <div className="mb-6">
            <h4 className="text-sm font-bold text-red-700 dark:text-red-300 mb-3 flex items-center">
              <Bug className="w-5 h-5 mr-2" />
              Detected Vulnerabilities
            </h4>
            <div className="space-y-3">
              {detectedVulnerabilities.map((vuln) => (
                <div
                  key={vuln.id}
                  className="p-4 bg-red-100 dark:bg-red-900/30 border-2 border-red-300 dark:border-red-800 rounded-xl"
                >
                  <div className="flex items-start justify-between mb-2">
                    <div>
                      <h5 className="font-bold text-red-800 dark:text-red-200">{vuln.name}</h5>
                      <p className="text-xs text-red-600 dark:text-red-400 mt-1">
                        {vuln.description}
                      </p>
                    </div>
                    <span className="px-2 py-1 bg-red-600 text-white text-xs rounded-full uppercase">
                      {vuln.severity}
                    </span>
                  </div>

                  <div className="flex items-center justify-between mt-3">
                    <div className="text-xs space-y-1">
                      <div className="flex items-center space-x-2">
                        <Target className="w-3 h-3 text-red-600" />
                        <span>Success Rate: {Math.round(vuln.successRate * 100)}%</span>
                      </div>
                      <div className="flex items-center space-x-2">
                        <TrendingUp className="w-3 h-3 text-red-600" />
                        <span>Potential Loss: ${(vuln.potentialDamage / 1e18 * 2000).toFixed(2)}</span>
                      </div>
                    </div>

                    <button
                      onClick={() => launchAttack(vuln)}
                      disabled={attackInProgress || !ethicalMode}
                      className="px-4 py-2 bg-red-600 text-white rounded-lg text-sm font-medium hover:bg-red-700 transition-all disabled:opacity-50 flex items-center space-x-1"
                    >
                      <Sword className="w-4 h-4" />
                      <span>Test Attack</span>
                    </button>
                  </div>
                </div>
              ))}
            </div>
          </div>
        )}

        {/* Available Attack Types */}
        <div className="mb-6">
          <h4 className="text-sm font-bold text-gray-700 dark:text-gray-300 mb-3 flex items-center">
            <Brain className="w-5 h-5 mr-2" />
            Common Attack Vectors
          </h4>
          <div className="grid grid-cols-1 gap-3">
            {availableAttacks.map((attack) => {
              const isDetected = detectedVulnerabilities.some(v => v.id === attack.id);
              return (
                <div
                  key={attack.id}
                  className={`p-3 rounded-lg border-2 transition-all ${
                    isDetected
                      ? 'bg-red-50 dark:bg-red-900/20 border-red-300 dark:border-red-700'
                      : 'bg-white dark:bg-[#0a0a0a] border-gray-200 dark:border-gray-700'
                  }`}
                >
                  <div className="flex items-center justify-between">
                    <div className="flex-1">
                      <div className="flex items-center space-x-2 mb-1">
                        <span className="text-sm font-semibold">{attack.name}</span>
                        {isDetected && (
                          <XCircle className="w-4 h-4 text-red-600" />
                        )}
                      </div>
                      <p className="text-xs text-gray-600 dark:text-gray-400">
                        {attack.description}
                      </p>
                    </div>
                    <span className={`px-2 py-1 text-xs rounded-full ${
                      attack.severity === 'critical'
                        ? 'bg-red-100 text-red-700 dark:bg-red-900/40 dark:text-red-300'
                        : attack.severity === 'high'
                        ? 'bg-orange-100 text-orange-700 dark:bg-orange-900/40 dark:text-orange-300'
                        : 'bg-yellow-100 text-yellow-700 dark:bg-yellow-900/40 dark:text-yellow-300'
                    }`}>
                      {attack.severity}
                    </span>
                  </div>
                </div>
              );
            })}
          </div>
        </div>

        {/* Attack Result */}
        {attackResult && selectedAttack && (
          <div className="mb-6">
            <h4 className="text-sm font-bold text-gray-700 dark:text-gray-300 mb-3 flex items-center">
              {attackResult.success ? <Skull className="w-5 h-5 mr-2 text-red-600" /> : <Award className="w-5 h-5 mr-2 text-green-600" />}
              Attack Simulation Result
            </h4>
            <div className={`p-4 rounded-xl border-2 ${
              attackResult.success
                ? 'bg-red-100 dark:bg-red-900/30 border-red-300 dark:border-red-800'
                : 'bg-green-100 dark:bg-green-900/30 border-green-300 dark:border-green-800'
            }`}>
              <div className="mb-3">
                <h5 className="font-bold mb-2">
                  {attackResult.success ? 'üí• Attack Successful' : 'üõ°Ô∏è Attack Defended'}
                </h5>
                {attackResult.success && (
                  <p className="text-sm text-red-700 dark:text-red-300">
                    Simulated loss: ${(attackResult.damage / 1e18 * 2000).toFixed(2)}
                  </p>
                )}
              </div>

              <div className="bg-white/50 dark:bg-black/20 p-3 rounded-lg font-mono text-xs space-y-1">
                {attackResult.trace.map((step, i) => (
                  <div key={i} className="flex items-start space-x-2">
                    <span className="text-gray-400">{i + 1}.</span>
                    <span>{step}</span>
                  </div>
                ))}
              </div>

              {/* Defense Recommendations */}
              <div className="mt-4 pt-4 border-t border-gray-300 dark:border-gray-700">
                <h6 className="text-sm font-bold mb-2">üõ°Ô∏è Recommended Defenses:</h6>
                <div className="space-y-2">
                  {getDefenseStrategies(selectedAttack).map((strategy, i) => (
                    <div key={i} className="flex items-center justify-between text-xs p-2 bg-white/50 dark:bg-black/20 rounded">
                      <div>
                        <div className="font-semibold">{strategy.name}</div>
                        <div className="text-gray-600 dark:text-gray-400">{strategy.description}</div>
                      </div>
                      <div className="text-right">
                        <div className="text-green-600 font-bold">{strategy.effectiveness}%</div>
                        <div className="text-gray-500">{strategy.cost} gas</div>
                      </div>
                    </div>
                  ))}
                </div>
              </div>
            </div>
          </div>
        )}

        {detectedVulnerabilities.length === 0 && !isScanning && (
          <div className="text-center py-12 text-gray-500 dark:text-gray-400">
            <Shield className="w-16 h-16 mx-auto mb-4 opacity-20" />
            <p className="text-sm">No vulnerabilities detected yet</p>
            <p className="text-xs mt-2">Click "Scan Contract" to analyze</p>
          </div>
        )}
      </div>

      {/* Stats Footer */}
      <div className="p-4 bg-gradient-to-r from-red-100 to-orange-100 dark:from-red-900/30 dark:to-orange-900/30 border-t border-red-200 dark:border-red-800">
        <div className="grid grid-cols-3 gap-4 text-center text-sm">
          <div>
            <div className="font-bold text-red-700 dark:text-red-300">{exploitsFound}</div>
            <div className="text-xs text-gray-600 dark:text-gray-400">Vulnerabilities</div>
          </div>
          <div>
            <div className="font-bold text-green-700 dark:text-green-300">{exploitsFixed}</div>
            <div className="text-xs text-gray-600 dark:text-gray-400">Defended</div>
          </div>
          <div>
            <div className="font-bold text-blue-700 dark:text-blue-300">
              {exploitsFound > 0 ? Math.round((exploitsFixed / exploitsFound) * 100) : 0}%
            </div>
            <div className="text-xs text-gray-600 dark:text-gray-400">Security Score</div>
          </div>
        </div>
      </div>
    </div>
  );
}
